<div class="text-center">
    <h1 class="display-4"> Pricing calculator</h1>
    <p class="text-heading3">Configure and estimate the costs for Azure products</p>
</div>

<script src="~/lib/jquery/dist/jquery.js"></script>

@*<script src="js/site.js" asp-append-version="true"></script>*@

<script type="text/javascript">
    jQuery(document).ready(function () {

        var allProducts;
        function ProjectList() {
            var org = $("#txtOrg").val();
            var pat = $("#txtpat").val();
            var url = "https://localhost:44362/api/v1/GetProductList";
            jQuery.ajax({
                url: url,
                type: "get",
                contentType: "application/json",
                success: function (result, status, xhr) {
                    //$(".divtoken").html(result);
                    if (result.length > 0) {
                        allProducts = result;
                        fillProductList(result);
                        calucalteTotalCost();
                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr)
                }
            });
        }

        function fillProductList(result) {

            for (var i = 0; i < result.length; i++) {
                var product = result[i];
                var productName = product.productName;   // 'Virtual Machines';
                var imageSrc = product.imageSrc;     // '/AzureIcons/VM-icon.png';
                var prodDesc = product.description;  // 'Provision Windows and Linux virtual machines in seconds';
                var prodPrice = product.unitPrice;    // 152.57;
                var totalprodPrice = prodPrice;
                var prodDetails = product.details;     //'1 D2 v3 (2 vCPUs, 8 GB RAM) x 730 Hours (Pay as you go), Windows (License included), OS Only; 0 managed disks – S4, 100 transaction units; Inter Region transfer type, 5 GB outbound data transfer from West US to East Asia';
                var itemDiv = ' <div class="divProductItems"> ' +
                    ' <div class="divproductimagecontainer inline-flex">' +
                    '    <img class="img-product" src=' + imageSrc + '>' +
                    '    <div>' +
                    '        <div class="imageDescription">' + productName + '</div> ' +
                    '       <div class="productDescription"> ' + prodDesc + '</div>' +
                    '   </div>' +
                    '  </div> ' +
                    '  <div class="productdetails">' + prodDetails + '</div> ' +
                    '  <div class="pricediv inline-flex margin-top30"> ' +
                    '      <div class="divpriceInfo"> ' +
                    '         <span class="costInfo">Per Instance</span> ' +
                    '         <span class="priceText margin-left20">$</span><span class="priceVal priceText margin-right20">' + prodPrice + '</span> ' +
                    '    </div>  <span class="costInfo margin-top10" style="font-style:normal">X</span> ' +
                    '   <div class="number-holder wide widest "> ' +
                    '      <div class="wa-textNumber">  ' +
                    ' <input class="spinbutton numeric" role="spinbutton"  aria-valuemax="100"  aria-valuemin="0"  aria-valuenow="1" type="number" min="0" value="1">  </div> </div>' +
                    '   <div class="divTotalpriceInfo">' +
                    '                 <span class="costInfo">Total: </span>' +
                    '                 <span class="priceText margin-left20">$</span><span class="totalpriceVal priceText margin-right20">' + totalprodPrice + '</span>' +
                    '    </div>' +
                    '  </div>' +
                    ' </div> ';
                $('.divProductList').append(itemDiv);
                registerspinbuttonEvent();
            }
        }

        function calucalteTotalCost() {
            var sum = 0;
            $('.totalpriceVal').each(function () {
                sum += parseFloat($(this).text());  // Or this.innerHTML, this.innerText
            });
            $(".totalcost").html(parseFloat(sum).toFixed(2));
        }

        // Clear Search Event
        $(".clear-search").click(function (e) {
            // Clear the ProductSearch textbox
            $(".product-search").val('');

            // Show All Product
            $('.divProductItems').show();

        });

        // Product Search Event
        $(".product-search").keyup(function (e) {
            var searchText = $(this).val().trim().toLowerCase();
          
            if (searchText.length > 0) {
                var searchProducts = $.grep(allProducts, function (n, i) { return n.productName.toLowerCase().indexOf(searchText.toLowerCase()) >= 0; });
                if (searchProducts.length > 0) {

                    // Show Only filtered Products
                    showFilteredData(searchProducts);
                }
            }
            else {
                // Show All Product
                $('.divProductItems').show();
            }
           
        });

        //Dispaly Filterd SearchProducts
        function showFilteredData(filteredData) {

            // First Hide all
            $('.divProductItems').hide();

           // Show Filtered Item Only
            $.each(filteredData, function (i, n) {

                $('.divProductItems').each(function () {
                    if ($(this).find("div.imageDescription").html().trim() == n.productName) {
                        $(this).show();
                    }
                });
            });
        }

        function registerspinbuttonEvent() {
            $(".spinbutton").change(function (e) {
                var selectedVal = $(this).val();
                var unitPrice = $(this).closest(".pricediv").find("span.priceVal").html().trim();
                var totalPrice = parseFloat(unitPrice * selectedVal).toFixed(2);

                // UpdateTotalPrice
                $(this).closest(".pricediv").find("span.totalpriceVal").html(totalPrice);

                calucalteTotalCost();
            });
        }

        // RegisterSpinButtonEvent
       // registerspinbuttonEvent();

        calucalteTotalCost();
        ProjectList();
    });
</script>

<div class="divpagemaincontent inline-flex">

  

    @*Load Product List*@

    <div id="divProductList" class="ProductList">
        <div class="product-search-container">
            <input class="product-search" aria-label="Search products" placeholder="Search products" value="">
            <button class="clear-search" aria-label="Clear search" type="submit" data-bi-an="body" data-bi-tn="clear-search">×</button>
        </div>
        <div class="">
            <div class="projectdivsection">
                <div class="row-header"> Product List: </div>
                <span class="spaninfo"> Select Product from the list to view the estimates</span>
                <table id="tblProductList"></table>
                <div class="divProductList"></div>
                
            </div>

            <div class="projectcreationmessage"></div>
        </div>
        @*End Load Product List*@

    </div>

    <div class="divestimate">
        <div class="divEstimateHeader"> Your Estimate</div>
        <div class="projectdivsection">
            <div class="row-header">Estimate</div>
            <span class="spaninfo"> Total estimation as per selected products</span>
            <div class="newsectionmessage"></div>
            <span class="costInfo">Total: </span><span class="priceText margin-left20 text-black-50">$</span><span class="totalcost priceText margin-right20 text-black-50 font-weight-bold">152.57</span>
        </div>
    </div>
</div>